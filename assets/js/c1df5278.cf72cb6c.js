"use strict";(self.webpackChunktodo_doc=self.webpackChunktodo_doc||[]).push([[4261],{514:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"level1/auth/authentication/support-read","title":"Support Read","description":"We\'ll do the following to support the read operation:","source":"@site/docs/level1/auth/authentication/support-read.md","sourceDirName":"level1/auth/authentication","slug":"/level1/auth/authentication/support-read","permalink":"/todo-doc/docs/level1/auth/authentication/support-read","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":40,"frontMatter":{"sidebar_label":"Support Read","sidebar_position":40},"sidebar":"tutorialSidebar","previous":{"title":"Support Create","permalink":"/todo-doc/docs/level1/auth/authentication/support-create"},"next":{"title":"Support Update","permalink":"/todo-doc/docs/level1/auth/authentication/support-update"}}');var s=o(4848),r=o(8453);const i={sidebar_label:"Support Read",sidebar_position:40},d="Support Read",a={},l=[{value:"Front End - Move initial <code>fetchTodos</code> call",id:"front-end---move-initial-fetchtodos-call",level:2},{value:"Front End - Modify <code>fetchTodos</code>",id:"front-end---modify-fetchtodos",level:2},{value:"API",id:"api",level:2},{value:"Undone todos",id:"undone-todos",level:3},{value:"Done todos",id:"done-todos",level:3},{value:"Business Object",id:"business-object",level:2},{value:"Undone todos",id:"undone-todos-1",level:3},{value:"Done todos",id:"done-todos-1",level:3},{value:"Verify with Postman",id:"verify-with-postman",level:2},{value:"Undone todos",id:"undone-todos-2",level:3},{value:"Done todos",id:"done-todos-2",level:3},{value:"Verify with Web Page",id:"verify-with-web-page",level:2}];function c(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"support-read",children:"Support Read"})}),"\n",(0,s.jsx)(n.p,{children:"We'll do the following to support the read operation:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Front End"}),": Modify the front end ",(0,s.jsx)(n.code,{children:"fetchTodos"})," function to send the Firebase authentication token."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"API"}),": Modify the ",(0,s.jsx)(n.strong,{children:"read undone todos and done todos endpoints"})," to make them protected (require authenticated access) and extract the user id from the request."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Business Object"}),": Modify the ",(0,s.jsx)(n.strong,{children:"get undone and done todos functions"})," to validate the user id and include it in the sql select statement."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify with Postman"}),": Verify the operation works using Postman."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify with Web Page"}),": Verify the operation works using the web page."]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"front-end---move-initial-fetchtodos-call",children:["Front End - Move initial ",(0,s.jsx)(n.code,{children:"fetchTodos"})," call"]}),"\n",(0,s.jsxs)(n.p,{children:["Before we modify ",(0,s.jsx)(n.code,{children:"fetchTodos"})," to send the authentication token, we need to observe and correct an issue."]}),"\n",(0,s.jsxs)(n.p,{children:["If you look at your html code, you'll notice ",(0,s.jsx)(n.code,{children:"fetchTodos"})," is called as soon as the document content is loaded. This has served us well thus far, and has ensured that we have ",(0,s.jsx)(n.code,{children:"todos"})," to display whenever the page is loaded."]}),"\n",(0,s.jsxs)(n.p,{children:["However, we're about to modify ",(0,s.jsx)(n.code,{children:"fetchTodos"})," to also send the authentication token, which requires a call to ",(0,s.jsx)(n.code,{children:"getIdToken"}),", which itself requires ",(0,s.jsx)(n.code,{children:"auth"})," to be fully initialized."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'document.addEventListener(\'DOMContentLoaded\', () => {\n    const todoForm = document.getElementById(\'todo-form\');\n    const newTodoInput = document.getElementById(\'new-todo\');\n\n    // Many lines of code...\n\n    //highlight-start\n    // Fetch all todos when the page loads\n    fetchTodos();\n    //highlight-end\n\n    // Many lines of code...\n\n    // Initialize Firebase\n    firebase.initializeApp(firebaseConfig);\n    const auth = firebase.auth();\n\n    // Set up the auth state listener\n    auth.onAuthStateChanged(async (user) => {\n        if (user) {\n            console.log("Signed in as:", user.uid);\n            const token = await getIdToken();\n            console.log("Auth header: Bearer", token);\n        } else {\n            console.log("No user signed in");\n        }\n    });\n\n    // Sign in anonymously\n    auth.signInAnonymously()\n        .catch(error => {\n            console.error("Error signing in:", error);\n        });\n\n    // Function to get the current user\'s ID token\n    // getIdToken will also manage to token\'s freshness\n    async function getIdToken() {\n        const user = auth.currentUser;\n        if (user) {\n            return user.getIdToken();\n        } else {\n            throw new Error("No user is signed in");\n        }\n    }\n\n    // Many lines of code...\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["That ",(0,s.jsx)(n.code,{children:"auth"})," initialization process makes network calls to Firebase, which takes time. But ",(0,s.jsx)(n.code,{children:"fetchTodos"})," runs immediately, before the initialization process can finish. This results in the following error:"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Error fetching todos: ReferenceError: can't access lexical declaration 'auth' before initialization"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To remedy this, we need to make sure ",(0,s.jsx)(n.code,{children:"fetchTodos"})," is called after ",(0,s.jsx)(n.code,{children:"auth"})," is initialized. Therefore, let's move the initial ",(0,s.jsx)(n.code,{children:"fetchTodos"})," call into ",(0,s.jsx)(n.code,{children:"auth"}),"'s ",(0,s.jsx)(n.code,{children:"onAuthStateChanged"})," event, which would then look like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set up the auth state listener\nauth.onAuthStateChanged(async (user) => {\n  if (user) {\n    console.log("Signed in as:", user.uid);\n    const token = await getIdToken();\n    console.log("Auth header: Bearer", token);\n    fetchTodos();\n  } else {\n    console.log("No user signed in");\n  }\n});\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Be sure you've either removed or commented out the standalone ",(0,s.jsx)(n.code,{children:"fetchTodos"})," call."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["After you've made this change, verify it works by refreshing your html page. You should see ",(0,s.jsx)(n.code,{children:"todos"}),", and there should be no errors in the javascript console (except perhaps the common ",(0,s.jsx)(n.code,{children:"favicon.ico"})," missing error.)"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"front-end---modify-fetchtodos",children:["Front End - Modify ",(0,s.jsx)(n.code,{children:"fetchTodos"})]}),"\n",(0,s.jsxs)(n.p,{children:["In your html page, the ",(0,s.jsx)(n.code,{children:"fetchTodos"})," javascript likely looks something like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'async function fetchTodos() {\n  try {\n    // Get the undone todos\n    const undoneResponse = await fetch("/api/todos/undone");\n    const undoneTodos = await undoneResponse.json();\n\n    // Get the done todos\n    const doneResponse = await fetch("/api/todos/done");\n    const doneTodos = await doneResponse.json();\n\n    // Display the todos\n    renderTodos(undoneTodos, doneTodos);\n  } catch (error) {\n    console.error("Error fetching todos:", error);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Like the previous create operation, we're going to change our function to add the authentication token to the authorization header so we can validate it on the backend and extract the id there."}),"\n",(0,s.jsx)(n.p,{children:"Update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'async function fetchTodos() {\n  try {\n    //highlight-start\n    // Get the user token\n    const token = await getIdToken();\n    //highlight-end\n\n    // Get the undone todos\n    //highlight-start\n    const undoneResponse = await fetch("/api/todos/undone", {\n      headers: {\n        Authorization: "Bearer " + token,\n      },\n    });\n    //highlight-end\n    const undoneTodos = await undoneResponse.json();\n\n    // Get the done todos\n    //highlight-start\n    const doneResponse = await fetch("/api/todos/done", {\n      headers: {\n        Authorization: "Bearer " + token,\n      },\n    });\n    //highlight-end\n    const doneTodos = await doneResponse.json();\n\n    // Display the todos\n    renderTodos(undoneTodos, doneTodos);\n  } catch (error) {\n    console.error("Error fetching todos:", error);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:'Note: You should put quotes around "Authorization" above. Docusaurus (this documentation tool) is artificially stripping them out.'}),"\n",(0,s.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,s.jsxs)(n.p,{children:["Let's update the API endpoints to use our ",(0,s.jsx)(n.code,{children:"verifyToken"})," middleware function."]}),"\n",(0,s.jsx)(n.h3,{id:"undone-todos",children:"Undone todos"}),"\n",(0,s.jsx)(n.p,{children:"Your current endpoint likely looks something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Read all active (undone) todos\napp.get("/api/todos/undone", async (req, res) => {\n  try {\n    const todos = await getAllUndoneTodos();\n    res.json(todos);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"Update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Read all active (undone) todos\n// highlight-next-line\napp.get("/api/todos/undone", verifyToken, async (req, res) => {\n  try {\n    // highlight-start\n    const user_id = req.user.uid;\n    const todos = await getAllUndoneTodos(user_id);\n    // highlight-end\n    res.json(todos);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.h3,{id:"done-todos",children:"Done todos"}),"\n",(0,s.jsx)(n.p,{children:"Your current endpoint likely looks something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Read all done todos\napp.get("/api/todos/done", async (req, res) => {\n  try {\n    const todos = await getAllDoneTodos();\n    res.json(todos);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"Update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Read all done todos\n// highlight-next-line\napp.get("/api/todos/done", verifyToken, async (req, res) => {\n  try {\n    // highlight-start\n    const user_id = req.user.uid;\n    const todos = await getAllDoneTodos(user_id);\n    // highlight-end\n    res.json(todos);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"business-object",children:"Business Object"}),"\n",(0,s.jsx)(n.p,{children:"Let's update the business object to include validating the user id and using it in the select statement."}),"\n",(0,s.jsx)(n.h3,{id:"undone-todos-1",children:"Undone todos"}),"\n",(0,s.jsx)(n.p,{children:"Your current function likely looks like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'async function getAllUndoneTodos() {\n  try {\n    const [rows] = await db.pool.query(\n      "SELECT * FROM todos WHERE is_done = 0 ORDER BY sort_order DESC"\n    );\n    return rows;\n  } catch (error) {\n    throw new Error(`Failed to fetch undone todos: ${error.message}`);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// highlight-next-line\nasync function getAllUndoneTodos(request_user_id) {\n  //highlight-start\n  // Validate request_user_id\n  if (request_user_id === undefined) {\n    throw new Error("Missing request_user_id");\n  }\n  //highlight-end\n\n  try {\n    //highlight-start\n    const [rows] = await db.pool.query(\n      "SELECT * FROM todos WHERE user_id = ? AND is_done = 0 ORDER BY sort_order DESC",\n      [request_user_id]\n    );\n    //highlight-end\n    return rows;\n  } catch (error) {\n    throw new Error(`Failed to fetch undone todos: ${error.message}`);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"done-todos-1",children:"Done todos"}),"\n",(0,s.jsx)(n.p,{children:"Your current function likely looks like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'async function getAllDoneTodos() {\n  try {\n    const [rows] = await db.pool.query(\n      "SELECT * FROM todos WHERE is_done !=0 ORDER BY is_done DESC"\n    );\n    return rows;\n  } catch (error) {\n    throw new Error(`Failed to fetch undone todos: ${error.message}`);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'//highlight-next-line\nasync function getAllDoneTodos(request_user_id) {\n  //highlight-start\n  // Validate request_user_id\n  if (request_user_id === undefined) {\n    throw new Error("Missing request_user_id");\n  }\n  //highlight-end\n\n  try {\n    //highlight-start\n    const [rows] = await db.pool.query(\n      "SELECT * FROM todos WHERE user_id = ? AND is_done !=0 ORDER BY is_done DESC",\n      [request_user_id]\n    );\n    //highlight-end\n    return rows;\n  } catch (error) {\n    throw new Error(`Failed to fetch done todos: ${error.message}`);\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Before verifying, be sure to restart your server if needed for changes to take place."}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Be sure you have a fresh token. Refresh your web page and view the javascript console for your current auth header."}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Firefox or Chrome may be better than Safari in displaying the entire contents of the auth header."}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"If your browser has been idle for a long time, or you\u2019re accessing your web page from a new browser or tab, your auth header may have a different user id than a previous user id because we\u2019re using anonymous sign-in."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"verify-with-postman",children:"Verify with Postman"}),"\n",(0,s.jsx)(n.h3,{id:"undone-todos-2",children:"Undone todos"}),"\n",(0,s.jsx)(n.p,{children:"Create a new request in Postman"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Type: ",(0,s.jsx)(n.code,{children:"GET"})]}),"\n",(0,s.jsxs)(n.li,{children:["URL: ",(0,s.jsx)(n.code,{children:"http://localhost:3004/api/todos/undone"})]}),"\n",(0,s.jsxs)(n.li,{children:["Headers:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Name: Authorization"}),"\n",(0,s.jsxs)(n.li,{children:["Value: Bearer ",(0,s.jsx)(n.code,{children:"<token>"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Expected Response:"}),"\n",(0,s.jsxs)(n.p,{children:["Status code: ",(0,s.jsx)(n.code,{children:"200 OK"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "id": 13480,\n    "user_id": "Sl8n6LJ86vQGSkwlsvGdqcLijxX2",\n    "name": "Do Laundry",\n    "is_done": 0,\n    "sort_order": 1737066299120\n  }\n]\n'})}),"\n",(0,s.jsx)(n.p,{children:"Note: Your exact response may vary depending on what your database contains."}),"\n",(0,s.jsx)(n.h3,{id:"done-todos-2",children:"Done todos"}),"\n",(0,s.jsx)(n.p,{children:"Create a new request in Postman"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Type: ",(0,s.jsx)(n.code,{children:"GET"})]}),"\n",(0,s.jsxs)(n.li,{children:["URL: ",(0,s.jsx)(n.code,{children:"http://localhost:3004/api/todos/done"})]}),"\n",(0,s.jsxs)(n.li,{children:["Headers:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Name: Authorization"}),"\n",(0,s.jsxs)(n.li,{children:["Value: Bearer ",(0,s.jsx)(n.code,{children:"<token>"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Expected Response:"}),"\n",(0,s.jsxs)(n.p,{children:["Status code: ",(0,s.jsx)(n.code,{children:"200 OK"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'[\n  {\n    "id": 13481,\n    "user_id": "Sl8n6LJ86vQGSkwlsvGdqcLijxX2",\n    "name": "Wash car",\n    "is_done": 1736956998698,\n    "sort_order": 1737066299120\n  }\n]\n'})}),"\n",(0,s.jsx)(n.p,{children:"Note: Your exact response may vary depending on what your database contains. You may need to manually update some todos in your database to set them 'done' to see results."}),"\n",(0,s.jsx)(n.h2,{id:"verify-with-web-page",children:"Verify with Web Page"}),"\n",(0,s.jsxs)(n.p,{children:["Open your web page. You should see ",(0,s.jsx)(n.code,{children:"todos"})," in both the undone and done sections. If not, create some new ",(0,s.jsx)(n.code,{children:"todos"})," and manually update some todos in your database to set them 'done' to see results."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,o)=>{o.d(n,{R:()=>i,x:()=>d});var t=o(6540);const s={},r=t.createContext(s);function i(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);