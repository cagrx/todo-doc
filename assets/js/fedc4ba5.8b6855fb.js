"use strict";(self.webpackChunktodo_doc=self.webpackChunktodo_doc||[]).push([[7863],{6909:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"level1/auth/authentication/support-update","title":"Support Update","description":"So far we\'ve modified create and read operations to handle our authentication token, from which we also extracted the user id. Create used that user id in order to set the underlying user_id value in the database. Read used that user id in order to select only that user\'s todos.","source":"@site/docs/level1/auth/authentication/support-update.md","sourceDirName":"level1/auth/authentication","slug":"/level1/auth/authentication/support-update","permalink":"/todo-doc/docs/level1/auth/authentication/support-update","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":50,"frontMatter":{"sidebar_label":"Support Update","sidebar_position":50},"sidebar":"tutorialSidebar","previous":{"title":"Support Read","permalink":"/todo-doc/docs/level1/auth/authentication/support-read"},"next":{"title":"Support Delete","permalink":"/todo-doc/docs/level1/auth/authentication/support-delete"}}');var s=t(4848),r=t(8453);const i={sidebar_label:"Support Update",sidebar_position:50},d="Support Update",a={},l=[{value:"Front End",id:"front-end",level:2},{value:"Modify <code>setTodoDone</code>",id:"modify-settododone",level:3},{value:"Modify <code>setTodoUndone</code>",id:"modify-settodoundone",level:3},{value:"API",id:"api",level:2},{value:"Set done",id:"set-done",level:3},{value:"Set undone",id:"set-undone",level:3},{value:"Business Object",id:"business-object",level:2},{value:"Verify with Postman",id:"verify-with-postman",level:2},{value:"Set done",id:"set-done-1",level:3},{value:"Set undone",id:"set-undone-1",level:3},{value:"Verify with Web Page",id:"verify-with-web-page",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"support-update",children:"Support Update"})}),"\n",(0,s.jsxs)(n.p,{children:["So far we've modified ",(0,s.jsx)(n.strong,{children:"create"})," and ",(0,s.jsx)(n.strong,{children:"read"})," operations to handle our authentication token, from which we also extracted the user id. ",(0,s.jsx)(n.strong,{children:"Create"})," used that user id in order to set the underlying user_id value in the database. ",(0,s.jsx)(n.strong,{children:"Read"})," used that user id in order to select only that user's ",(0,s.jsx)(n.code,{children:"todos"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["In each of those cases, the endpoints called ",(0,s.jsx)(n.code,{children:"verifyToken"})," which validated that the user was authenticated. If the user was not, then ",(0,s.jsx)(n.code,{children:"veifyToken"})," failed and immediately returned an error status code, and prevented further execution of the route."]}),"\n",(0,s.jsxs)(n.p,{children:["This ",(0,s.jsx)(n.strong,{children:"protected"})," the endpoint by confirming that the user is signed in and their identity is valid."]}),"\n",(0,s.jsxs)(n.p,{children:["In our current application, the ",(0,s.jsx)(n.strong,{children:"update"})," and ",(0,s.jsx)(n.strong,{children:"delete"})," operations aren't going to use the user id in any of its processing yet."]}),"\n",(0,s.jsxs)(n.p,{children:["However, we still want to ensure those operations are protected - we only want valid users to be able to perform them. So we will continue modify those endpoints to call ",(0,s.jsx)(n.code,{children:"verifyToken"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"We'll do the following to protect the update operation:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Front End"}),": Modify the front end ",(0,s.jsx)(n.code,{children:"setTodoDone"})," and ",(0,s.jsx)(n.code,{children:"setTodoUndone"})," functions to send the Firebase authentication token."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"API"}),": Modify the ",(0,s.jsx)(n.strong,{children:"update set-done and set-undone endpoints"})," to make them protected (require authenticated access)."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Business Object"}),": At this point, the API handles rejecting unauthenticated requests, so there's nothing to do here."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify with Postman"}),": Verify the operation works using Postman."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify with Web Page"}),": Verify the operation works using the web page."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"front-end",children:"Front End"}),"\n",(0,s.jsxs)(n.h3,{id:"modify-settododone",children:["Modify ",(0,s.jsx)(n.code,{children:"setTodoDone"})]}),"\n",(0,s.jsxs)(n.p,{children:["In your html page, the ",(0,s.jsx)(n.code,{children:"setTodoDone"})," javascript likely looks something like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set a todo as done\nasync function setTodoDone(id) {\n  try {\n    await fetch(`/api/todos/${id}/set-done`, {\n      method: "PUT",\n    });\n    fetchTodos();\n  } catch (error) {\n    console.error("Error setting todo to done:", error);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Update your function to send the authentication header like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set a todo as done\nasync function setTodoDone(id) {\n  try {\n    //highlight-start\n    // Get the user token\n    const token = await getIdToken();\n    //highlight-end\n\n    // Call the api\n    //highlight-start\n    const response = await fetch(`/api/todos/${id}/set-done`, {\n      method: "PUT",\n      headers: {\n        Authorization: "Bearer " + token,\n      },\n      //highlight-end\n    });\n    fetchTodos();\n  } catch (error) {\n    alert(`An unexpected error occured: ${error.message}`);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:'Note: You should put quotes around "Authorization" above. Docusaurus (this documentation tool) is artificially stripping them out.'}),"\n",(0,s.jsxs)(n.h3,{id:"modify-settodoundone",children:["Modify ",(0,s.jsx)(n.code,{children:"setTodoUndone"})]}),"\n",(0,s.jsxs)(n.p,{children:["In your html page, the ",(0,s.jsx)(n.code,{children:"setTodoUndone"})," javascript likely looks something like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set a todo as undone\nasync function setTodoUndone(id) {\n  try {\n    await fetch(`/api/todos/${id}/set-undone`, {\n      method: "PUT",\n    });\n    fetchTodos();\n  } catch (error) {\n    console.error("Error setting todo to undone:", error);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Update your function to send the authentication header like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set a todo as undone\nasync function setTodoUndone(id) {\n  try {\n    //highlight-start\n    // Get the user token\n    const token = await getIdToken();\n    //highlight-end\n\n    // Call the api\n    //highlight-start\n    const response = await fetch(`/api/todos/${id}/set-undone`, {\n      method: "PUT",\n      headers: {\n        Authorization: "Bearer " + token,\n      },\n      //highlight-end\n    });\n    fetchTodos();\n  } catch (error) {\n    alert(`An unexpected error occured: ${error.message}`);\n  }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:'Note: You should put quotes around "Authorization" above. Docusaurus (this documentation tool) is artificially stripping them out.'}),"\n",(0,s.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,s.jsxs)(n.p,{children:["Let's update the API endpoints to use our ",(0,s.jsx)(n.code,{children:"verifyToken"})," middleware function."]}),"\n",(0,s.jsx)(n.h3,{id:"set-done",children:"Set done"}),"\n",(0,s.jsx)(n.p,{children:"Your current endpoint likely looks something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set todo as done\napp.put("/api/todos/:id/set-done", async (req, res) => {\n  try {\n    const { id } = req.params;\n    const result = await setTodoDone(id);\n    res.json(result);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"We're only going to protect the endpoint for now, so update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set todo as done\n// highlight-next-line\napp.put("/api/todos/:id/set-done", verifyToken, async (req, res) => {\n  try {\n    const { id } = req.params;\n    const result = await setTodoDone(id);\n    res.json(result);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"Note: We're not using the user id at this point, so no need to extract it from the request object."}),"\n",(0,s.jsx)(n.h3,{id:"set-undone",children:"Set undone"}),"\n",(0,s.jsx)(n.p,{children:"Your current endpoint likely looks something like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set todo as undone\napp.put("/api/todos/:id/set-undone", async (req, res) => {\n  try {\n    const { id } = req.params;\n    const result = await setTodoUndone(id);\n    res.json(result);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.p,{children:"Likewise, update your function to look like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// Set todo as undone\n// highlight-next-line\napp.put("/api/todos/:id/set-undone", verifyToken, async (req, res) => {\n  try {\n    const { id } = req.params;\n    const result = await setTodoUndone(id);\n    res.json(result);\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n'})}),"\n",(0,s.jsx)(n.h2,{id:"business-object",children:"Business Object"}),"\n",(0,s.jsx)(n.p,{children:"As mentioned above, at this point we're not using the user id in the set done and set undone operations, so there's nothing to change."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Before verifying, be sure to restart your server if needed for changes to take place."}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Be sure you have a fresh token. Refresh your web page and view the javascript console for your current auth header."}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"Firefox or Chrome may be better than Safari in displaying the entire contents of the auth header."}),"\n"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"If your browser has been idle for a long time, or you\u2019re accessing your web page from a new browser or tab, your auth header may have a different user id than a previous user id because we\u2019re using anonymous sign-in."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"verify-with-postman",children:"Verify with Postman"}),"\n",(0,s.jsx)(n.h3,{id:"set-done-1",children:"Set done"}),"\n",(0,s.jsx)(n.p,{children:"Create a new request in Postman"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Type: ",(0,s.jsx)(n.code,{children:"PUT"})]}),"\n",(0,s.jsxs)(n.li,{children:["URL: ",(0,s.jsx)(n.code,{children:"http://localhost:3004/api/todos/{id}/set-done"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Example: ",(0,s.jsx)(n.a,{href:"http://localhost:3004/api/todos/13478/set-done",children:"http://localhost:3004/api/todos/13478/set-done"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Headers:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Name: Authorization"}),"\n",(0,s.jsxs)(n.li,{children:["Value: Bearer ",(0,s.jsx)(n.code,{children:"<token>"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Expected Response:"}),"\n",(0,s.jsxs)(n.p,{children:["Status code: ",(0,s.jsx)(n.code,{children:"200 OK"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "message": "Todo set to done successfully"\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"set-undone-1",children:"Set undone"}),"\n",(0,s.jsx)(n.p,{children:"Create a new request in Postman"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Type: ",(0,s.jsx)(n.code,{children:"PUT"})]}),"\n",(0,s.jsxs)(n.li,{children:["URL: ",(0,s.jsx)(n.code,{children:"http://localhost:3004/api/todos/{id}/set-undone"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Example: ",(0,s.jsx)(n.a,{href:"http://localhost:3004/api/todos/13478/set-undone",children:"http://localhost:3004/api/todos/13478/set-undone"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Headers:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Name: Authorization"}),"\n",(0,s.jsxs)(n.li,{children:["Value: Bearer ",(0,s.jsx)(n.code,{children:"<token>"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Expected Response:"}),"\n",(0,s.jsxs)(n.p,{children:["Status code: ",(0,s.jsx)(n.code,{children:"200 OK"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "message": "Todo set as undone successfully"\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"verify-with-web-page",children:"Verify with Web Page"}),"\n",(0,s.jsxs)(n.p,{children:["Open your web page. You should see ",(0,s.jsx)(n.code,{children:"todos"})," in both the undone and done sections. If not, create some new ",(0,s.jsx)(n.code,{children:"todos"}),". Click the ",(0,s.jsx)(n.strong,{children:"Mark Complete"})," and ",(0,s.jsx)(n.strong,{children:"Mark Incomplete"})," buttons to verify the operation works."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>d});var o=t(6540);const s={},r=o.createContext(s);function i(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);